import { GoogleGenAI } from "@google/genai";

// Fallbacks specific to her interests in case API fails
const FALLBACK_WISHES = [
  "–ù–∞—Å—Ç—è, –∂–µ–ª–∞—é —Å–∫–∞–∫–∞—Ç—å –∫ —É—Å–ø–µ—Ö—É –≥–∞–ª–æ–ø–æ–º –≤–º–µ—Å—Ç–µ —Å –ª—é–±–∏–º—ã–º –®–µ–∫—Å–ø–∏—Ä–æ–º! –ü—É—Å—Ç—å –∂–∏–∑–Ω—å –±—É–¥–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–π, –∫–∞–∫ –≥–æ—Ä—ã –ê–±—Ö–∞–∑–∏–∏! üêéüèîÔ∏è",
  "–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è, –ê–Ω–∞—Å—Ç–∞—Å–∏—è! –ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π —Ç–≤–æ–π –¥–µ–Ω—å –±—É–¥–µ—Ç —Ö–∏—Ç–æ–≤—ã–º, –∫–∞–∫ —Ç—Ä–µ–∫–∏ –≠–º–∏–Ω–µ–º–∞, –∏ –¥—É—à–µ–≤–Ω—ã–º, –∫–∞–∫ –ø–µ—Å–Ω–∏ –§–∞—Ä–∞–æ–Ω–∞! üé§üî•",
  "–ù–∞—Å—Ç—è, –ø—É—Å—Ç—å –ê–±—Ö–∞–∑–∏—è –¥–∞—Ä–∏—Ç —Ç–µ–±–µ —Å–æ–ª–Ω—Ü–µ, –∞ –®–µ–∫—Å–ø–∏—Ä ‚Äî –∫—Ä—ã–ª—å—è –∑–∞ —Å–ø–∏–Ω–æ–π! –ü–æ–π –∏ —Å–∏—è–π! ‚ú®üèá",
  "–ñ–µ–ª–∞—é –±—Ä–∞—Ç—å –ª—é–±—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è —Ç–∞–∫ –∂–µ –ª–µ–≥–∫–æ, –∫–∞–∫ –≤ –∫–æ–Ω–Ω–æ–º —Å–ø–æ—Ä—Ç–µ! –ë—É–¥—å —Å—á–∞—Å—Ç–ª–∏–≤–∞ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å, –ù–∞—Å—Ç—è! üèÜüå¥",
  "–ü—É—Å—Ç—å —Ç–≤–æ–π –≥–æ–ª–æ—Å –∑–≤—É—á–∏—Ç –≥—Ä–æ–º–∫–æ, –∞ —Å–µ—Ä–¥—Ü–µ –±—å–µ—Ç—Å—è –≤ —Ä–∏—Ç–º–µ –ª—é–±–∏–º–æ–π –º—É–∑—ã–∫–∏! –ü—Ä–∏–≤–µ—Ç –®–µ–∫—Å–ø–∏—Ä—É! üé∂‚ù§Ô∏è",
  "–ò–∑ –ì–µ—Ä–º–∞–Ω–∏–∏ —Å –ª—é–±–æ–≤—å—é, –≤ –ê–±—Ö–∞–∑–∏—é —Å –¥—É—à–æ–π! –ù–∞—Å—Ç—è, –ø—É—Å—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–∏–Ω–æ—Å–∏—Ç –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è –ø–µ—Å–µ–Ω! üá©üá™‚û°Ô∏èüá¶üáß"
];

// Themes tailored to her personality
const THEMES = [
  "–≤ —Å—Ç–∏–ª–µ –¥–µ—Ä–∑–∫–æ–≥–æ —Ä—ç–ø-—Ö–∏—Ç–∞ (–∫–∞–∫ Eminem –∏–ª–∏ Pharaoh)",
  "–æ—á–µ–Ω—å —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ –∏ –º–∏–ª–æ–µ (—Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∫–æ–Ω—è –®–µ–∫—Å–ø–∏—Ä–∞)",
  "–ø–æ—ç—Ç–∏—á–Ω–æ–µ –∏ –∫—Ä–∞—Å–∏–≤–æ–µ (–ø—Ä–æ –≥–æ—Ä—ã –ê–±—Ö–∞–∑–∏–∏ –∏ —Å–≤–æ–±–æ–¥—É)",
  "—ç–Ω–µ—Ä–≥–∏—á–Ω–æ–µ –∏ –¥—Ä–∞–π–≤–æ–≤–æ–µ (–∫–∞–∫ —Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è)",
  "—Å–º–µ—à–Ω–æ–µ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ (–æ—Ç –ª–∏—Ü–∞ –µ—ë –∫–æ–Ω—è –®–µ–∫—Å–ø–∏—Ä–∞)",
  "–º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ (–ø—Ä–æ —Å—Ü–µ–Ω—É –∏ –ø–µ—Å–Ω–∏)",
  "–∫–æ—Ä–æ—Ç–∫–æ–µ –∏ —è—Ä–∫–æ–µ —Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏"
];

export const generateBirthdayWish = async (): Promise<string> => {
  // Helper to get a random fallback
  const getRandomFallback = () => FALLBACK_WISHES[Math.floor(Math.random() * FALLBACK_WISHES.length)];

  try {
    const apiKey = process.env.API_KEY;
    
    // If no key is found, return a random pre-written wish immediately
    if (!apiKey) {
      console.warn("API Key missing, using random fallback.");
      return getRandomFallback();
    }

    const ai = new GoogleGenAI({ apiKey });
    
    // Select a random theme
    const randomTheme = THEMES[Math.floor(Math.random() * THEMES.length)];
    
    // Detailed Context Profile
    const contextProfile = `
      –ò–º—è: –ù–∞—Å—Ç—è (–ê–Ω–∞—Å—Ç–∞—Å–∏—è).
      –î–µ–≤—É—à–∫–∞. 
      –£–≤–ª–µ—á–µ–Ω–∏—è: –ö–æ–Ω–Ω—ã–π —Å–ø–æ—Ä—Ç, –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ–µ–≥–æ –∫–æ–Ω—è –ø–æ –∫–ª–∏—á–∫–µ "–®–µ–∫—Å–ø–∏—Ä". –õ—é–±–∏—Ç –ø–µ—Ç—å.
      –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –≤–∫—É—Å—ã: Eminem, Pharaoh (—Ä—É—Å—Å–∫–∏–π —Ä—ç–ø–µ—Ä).
      –õ–æ–∫–∞—Ü–∏—è: –†–æ–¥–æ–º –∏–∑ –ì–µ—Ä–º–∞–Ω–∏–∏, –Ω–æ –∂–∏–≤–µ—Ç –≤ –ê–±—Ö–∞–∑–∏–∏. –ï–π –æ—á–µ–Ω—å –Ω—Ä–∞–≤–∏—Ç—Å—è –≤ –ê–±—Ö–∞–∑–∏–∏.
    `;

    const prompt = `–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ) –¥–ª—è –¥–µ–≤—É—à–∫–∏ –ø–æ –∏–º–µ–Ω–∏ –ù–∞—Å—Ç—è.
      –§–∞–∫—Ç—ã –æ –∏–º–µ–Ω–∏–Ω–Ω–∏—Ü–µ: ${contextProfile}
      –°—Ç–∏–ª—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è: ${randomTheme}.
      
      –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –∏–º—è –ù–∞—Å—Ç—è –∏–ª–∏ –ê–Ω–∞—Å—Ç–∞—Å–∏—è.
      2. –ò—Å–ø–æ–ª—å–∑—É–π —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–∫—Ç (–ø—Ä–æ –∫–æ–Ω—è, –º—É–∑—ã–∫—É –∏–ª–∏ –ê–±—Ö–∞–∑–∏—é).
      3. –î–ª–∏–Ω–∞: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
      4. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —ç–º–æ–¥–∑–∏.
      5. –ë—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º, –∏–∑–±–µ–≥–∞–π –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π.
      6. –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏: ${Date.now()}`;

    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: prompt,
      config: {
        temperature: 1.3, // High creativity
        topP: 0.95,
      }
    });

    const text = response.text;
    return text || getRandomFallback();

  } catch (error) {
    console.error("Gemini API Error:", error);
    return getRandomFallback();
  }
};